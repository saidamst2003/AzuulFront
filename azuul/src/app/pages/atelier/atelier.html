<app-navbar></app-navbar>

<!-- Toast Notifications -->
<div class="toast-container">
  <div *ngFor="let toast of toasts" 
       class="toast" 
       [class]="'toast-' + toast.type"
       (click)="closeToast(toast)">
    <span class="toast-message">{{ toast.message }}</span>
    <button class="toast-close" (click)="closeToast(toast)">×</button>
  </div>
</div>

<section class="hero-section">
  <div class="hero-content">
    <h1 *ngIf="!isCoach">Nos Ateliers Créatifs</h1>
    <h1 *ngIf="isCoach">Mon Ateliers Créatifs</h1>
    <p *ngIf="!isCoach">Découvrez nos ateliers uniques où créativité et bien-être se rencontrent pour des moments inoubliables</p>
  </div>
</section>

<!-- Barre d'actions admin -->
<div *ngIf="isAdmin" class="admin-toolbar">
  <button class="admin-action-btn" (click)="openCreateForm()">
    <i class="fas fa-plus"></i> Créer un Atelier
  </button>
  <button class="admin-action-btn fix-coaches-btn" (click)="fixAllAteliersWithoutCoaches()" 
          *ngIf="hasAteliersWithoutCoaches()">
    <i class="fas fa-wrench"></i> Corriger les Ateliers sans Coach
  </button>
</div>



<!-- Authentication Warning -->
<div *ngIf="!isAuthenticated" class="auth-warning">
  <i class="fas fa-info-circle"></i>
  <span>Connectez-vous pour accéder à toutes les fonctionnalités</span>
  <button class="login-btn" (click)="navigateToLogin()">Se connecter</button>
</div>

<main class="main-container">

  <!-- Message d'erreur globale -->
  <div *ngIf="error" class="error-message global-error">{{ error }}</div>

  <!-- Barre de progression upload -->
  <div *ngIf="uploadProgress > 0 && uploadProgress < 100" class="upload-progress">
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="uploadProgress"></div>
    </div>
    <span>Upload en cours... {{ uploadProgress }}%</span>
  </div>

  <!-- Grille des ateliers -->
  <div class="workshops-grid">

    <div *ngFor="let atelier of ateliers" class="workshop-card">

      <div class="workshop-image">
        <img [src]="getImageUrlByCategorie(atelier.categorie)"
             [alt]="atelier.nom + ' image par catégorie'"
             loading="lazy"
             class="workshop-img"
             (error)="onImageError($event, atelier)" />
      </div>

      <!-- Actions Admin (Modifier / Supprimer) -->
      <div *ngIf="isAdmin" class="admin-card-actions">
        <button class="icon-btn" (click)="$event.stopPropagation(); openEditForm(atelier)" title="Modifier">
          <i class="fas fa-edit"></i>
        </button>
        <button class="icon-btn" (click)="$event.stopPropagation(); deleteAtelier(atelier.id)" title="Supprimer">
          <i class="fas fa-trash"></i>
        </button>
      </div>

      <div class="workshop-content">
        <h3 class="workshop-title">{{ atelier.nom }}</h3>
        <p class="workshop-description">{{ atelier.description }}</p>

        <div class="workshop-metadata">
          <span class="workshop-genre" *ngIf="atelier.categorie">
            <i class="fas fa-tag"></i> {{ atelier.categorie }}
          </span>
          <span class="workshop-coach" *ngIf="atelier.coach">
            <i class="fas fa-user"></i> {{ atelier.coach.fullName || ((atelier.coach.prenom || '') + ' ' + (atelier.coach.nom || '')) }}
          </span>
          <span class="workshop-coach no-coach" *ngIf="!atelier.coach && isAdmin">
            <i class="fas fa-exclamation-triangle"></i> Aucun coach assigné
            <button class="assign-coach-btn" (click)="assignFirstAvailableCoach(atelier)" 
                    *ngIf="coaches.length > 0" title="Assigner le premier coach disponible">
              <i class="fas fa-user-plus"></i>
            </button>
          </span>
        </div>

        <div class="workshop-footer">
          <div class="workshop-info">
            <span class="info-item">
              <i class="far fa-calendar-alt"></i> {{ atelier.date | date: 'dd/MM/yyyy' }}
            </span>
            <span class="info-item">
              <i class="far fa-clock"></i> {{ atelier.heure }}
            </span>
          </div>
          <button *ngIf="isClient()" class="workshop-btn" (click)="openReservationModal(atelier)">Réserver <i class="fas fa-arrow-right"></i></button>
          <div *ngIf="!isClient() && isAuthenticated" class="reservation-info">
            
          </div>
          <div *ngIf="!isAuthenticated" class="reservation-info">
        
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Message si aucun atelier -->
  <div *ngIf="ateliers.length === 0 && !error" class="no-workshops">
    <i class="fas fa-calendar-times"></i>
    <h3>Aucun atelier disponible</h3>
    <p>Les nouveaux ateliers seront bientôt disponibles !</p>
  </div>

</main>

<!-- Modal création/modification atelier -->
<div *ngIf="showForm" class="modal-backdrop" (click)="closeModalOnBackdrop($event)">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <form [formGroup]="atelierForm" (ngSubmit)="submitForm()" novalidate enctype="multipart/form-data">

      <div class="modal-header">
        <h3 class="modal-title">{{ editingAtelier ? 'Modifier' : 'Créer' }} un Atelier</h3>
        <button type="button" class="close-btn" (click)="cancel()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <div class="modal-body">

        <!-- Nom -->
        <div class="form-group">
          <label for="nom" class="required">Nom de l'atelier</label>
          <input id="nom" formControlName="nom" class="form-control" placeholder="Ex: Atelier de peinture" required />
          <div class="error-text" *ngIf="atelierForm.get('nom')?.errors?.['required'] && atelierForm.get('nom')?.touched">
            Le nom est obligatoire
          </div>
          <div class="error-text" *ngIf="atelierForm.get('nom')?.errors?.['minlength'] && atelierForm.get('nom')?.touched">
            Le nom doit contenir au moins 3 caractères
          </div>
        </div>

        <!-- Description -->
        <div class="form-group">
          <label for="description" class="required">Description</label>
          <textarea id="description" formControlName="description" class="form-control textarea" rows="3" placeholder="Décrivez votre atelier..." required></textarea>
          <div class="error-text" *ngIf="atelierForm.get('description')?.errors?.['required'] && atelierForm.get('description')?.touched">
            La description est obligatoire
          </div>
          <div class="error-text" *ngIf="atelierForm.get('description')?.errors?.['minlength'] && atelierForm.get('description')?.touched">
            La description doit contenir au moins 10 caractères
          </div>
        </div>

        <!-- Catégorie -->
        <div class="form-group">
          <label for="categorie" class="required">Catégorie</label>
          <select id="categorie" formControlName="categorie" class="form-control" required>
            <option value="">Sélectionnez une catégorie</option>
            <option value="ART">Art</option>
            <option value="ECRITURE">Écriture</option>
            <option value="JARDINAGE">Jardinage</option>
            <option value="BIJOUX">Bijoux</option>
            <option value="MAKEUP">Makeup</option>
            <option value="YOGA">Yoga</option>
            <option value="FITNESS">Fitness</option>
            <option value="NATATION">Natation</option>
          </select>
          <div class="error-text" *ngIf="atelierForm.get('categorie')?.errors?.['required'] && atelierForm.get('categorie')?.touched">
            La catégorie est obligatoire
          </div>
        </div>

        <!-- Coach -->
        <div class="form-group">
          <label for="coachId" class="required">Coach</label>
          <select id="coachId" formControlName="coachId" class="form-control" required>
            <option value="">Sélectionnez un coach</option>
            <option *ngFor="let coach of filteredCoaches" [value]="coach.id">{{ coach.fullName || ((coach.prenom || '') + ' ' + (coach.nom || '')) }}</option>
          </select>
          <div class="error-text" *ngIf="atelierForm.get('coachId')?.errors?.['required'] && atelierForm.get('coachId')?.touched">
            Le coach est obligatoire
          </div>
          <div class="error-text" *ngIf="filteredCoaches.length === 0">
            Aucun coach disponible pour le moment
          </div>
        </div>

        <!-- Date et Heure -->
        <div class="form-row">
          <div class="form-group">
            <label for="date" class="required">Date</label>
            <input id="date" type="date" formControlName="date" class="form-control" [min]="getTodayDate()" required />
            <div class="error-text" *ngIf="atelierForm.get('date')?.errors?.['required'] && atelierForm.get('date')?.touched">
              La date est obligatoire
            </div>
            <div class="error-text" *ngIf="atelierForm.get('date')?.errors?.['futureDate'] && atelierForm.get('date')?.touched">
              La date doit être dans le futur
            </div>
          </div>

          <div class="form-group">
            <label for="heure" class="required">Heure</label>
            <input id="heure" type="time" formControlName="heure" class="form-control" required />
            <div class="error-text" *ngIf="atelierForm.get('heure')?.errors?.['required'] && atelierForm.get('heure')?.touched">
              L'heure est obligatoire
            </div>
          </div>
        </div>

      </div>

      <!-- Footer with buttons -->
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancel()">Annuler</button>
        <button type="submit" class="btn btn-primary" [disabled]="!canSubmitForm() || isSubmitting">
          {{ getSubmitButtonText() }}
        </button>
      </div>

    </form>
  </div>
</div>
<!-- Modal de réservation (simplifié) -->
<div *ngIf="showReservationModal" class="modal-backdrop reservation-modal-backdrop" (click)="closeReservationModalOnBackdrop($event)">
  <div class="modal-content reservation-modal-content" (click)="$event.stopPropagation()">
    
    <!-- Header -->
    <div class="reservation-modal-header">
      <button type="button" class="reservation-close-btn" (click)="closeReservationModal()">
        <i class="fas fa-times"></i>
      </button>
      <div class="header-content">
        <div class="atelier-preview">
          <img class="atelier-preview-image" [src]="getImageUrlByCategorie(selectedAtelier?.categorie || '')" alt="aperçu" />
          <div class="atelier-preview-overlay">
            <i class="fas fa-palette"></i>
          </div>
        </div>
        <div class="header-text">
          <h2 class="modal-title">Réserver l'atelier</h2>
          <p class="modal-subtitle workshop-name">{{ selectedAtelier?.nom }}</p>
          <div class="coach-header-info" *ngIf="selectedAtelier?.coach || selectedAtelier?.coachId">
            <p class="modal-subtitle coach-name">
              <i class="fas fa-user-tie"></i>
              <span *ngIf="selectedAtelier?.coach as coach">
                Coach: {{ coach.fullName || (((coach.prenom || '') + ' ' + (coach.nom || ''))) }}
              </span>
              <span *ngIf="!selectedAtelier?.coach && selectedAtelier?.coachId">
                Coach ID: {{ selectedAtelier?.coachId }} (Chargement...)
              </span>
            </p>
            <p class="coach-specialty-header" *ngIf="selectedAtelier?.coach?.specialite">
              <i class="fas fa-star"></i>
              {{ selectedAtelier?.coach?.specialite }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Body -->
    <div class="reservation-modal-body">
        <div class="atelier-date-info" *ngIf="selectedAtelier?.date">
          <div class="section-header" style="margin-top: 20px; margin-bottom: 15px;">
            <i class="far fa-clock"></i>
            <span>Date de l'atelier</span>
          </div>
          <p class="modal-info">
            <i class="far fa-calendar"></i>
            {{ selectedAtelier?.date | date: 'dd/MM/yyyy' }}
          </p>
        </div>
   

      <!-- Coach Section -->
      <div class="coach-section" *ngIf="selectedAtelier?.coach || selectedAtelier?.coachId">
        <div class="section-header">
          <i class="fas fa-user-tie"></i>
          <span>Coach de l'atelier</span>
        </div>
        <div class="coach-info-card" *ngIf="selectedAtelier?.coach as coach">
          <div class="coach-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="coach-details">
            <h4 class="coach-name">{{ coach.fullName || (((coach.prenom || '') + ' ' + (coach.nom || ''))) }}</h4>
            
          
          </div>
        </div>
        <div class="coach-info-card" *ngIf="!selectedAtelier?.coach && selectedAtelier?.coachId">
          <div class="coach-avatar">
            <i class="fas fa-user"></i>
          </div>
          <div class="coach-details">
            <h4 class="coach-name">Coach ID: {{ selectedAtelier?.coachId }}</h4>
            <p class="coach-specialty">
              <i class="fas fa-info-circle"></i>
              Informations du coach en cours de chargement...
            </p>
            <p class="coach-specialty" style="font-size: 0.8rem; color: #666;">
              <i class="fas fa-exclamation-triangle"></i>
              Les détails du coach ne sont pas encore chargés
            </p>
          </div>
        </div>
      </div>

      <!-- Description -->
      <div class="description-section">
        <div class="section-header">
          <i class="fas fa-info-circle"></i>
          <span>Description de l'atelier</span>
        </div>
        <p class="modal-info">
          {{ selectedAtelier?.description || 'Pas de description disponible.' }}
        </p>
      </div>

    </div>

    <!-- Footer -->
    <div class="reservation-modal-footer">
      <div class="reservation-summary" *ngIf="selectedAtelier">
        <span>
          <i class="fas fa-user-tie"></i>
          Coach:
          <span *ngIf="selectedAtelier.coach as coach; else coachIdOnly">
            {{ coach.fullName || (((coach.prenom || '') + ' ' + (coach.nom || ''))) }}
          </span>
          <ng-template #coachIdOnly>
            <span *ngIf="selectedAtelier.coachId">#{{ selectedAtelier.coachId }}</span>
            <span *ngIf="!selectedAtelier.coachId">Non assigné</span>
          </ng-template>
        </span>
      </div>
      <button class="reservation-btn btn-secondary" (click)="closeReservationModal()">
        <i class="fas fa-times"></i>
        Fermer
      </button>
      <button class="reservation-btn btn-primary confirm-btn" (click)="createReservation()" [disabled]="!isClient()">
        <i class="fas fa-check"></i>
        Confirmer
      </button>
      <div *ngIf="duplicateWarning" class="duplicate-warning" style="color:#d9534f; font-size:0.9rem; margin-top:8px; width:100%">
        {{ duplicateWarning }}
      </div>
    </div>

  </div>
</div>

<!-- Confirmation de réservation -->
<div *ngIf="showReservationConfirmation" class="modal-backdrop reservation-modal-backdrop" (click)="closeReservationConfirmation()">
  <div class="modal-content reservation-modal-content" (click)="$event.stopPropagation()">
    <div class="reservation-modal-header">
      <button type="button" class="reservation-close-btn" (click)="closeReservationConfirmation()">
        <i class="fas fa-times"></i>
      </button>
      <div class="header-content">
        <div class="header-text">
          <h2 class="modal-title">Réservation confirmée</h2>
          <p class="modal-subtitle">Votre réservation a été créée avec succès.</p>
        </div>
      </div>
    </div>

    <div class="reservation-modal-body">
      <div class="description-section" *ngIf="reservationConfirmation as r">
        <div class="section-header">
          <i class="fas fa-receipt"></i>
          <span>Détails de la réservation</span>
        </div>
        <p class="modal-info"><strong>ID:</strong> {{ r.id }}</p>
        <p class="modal-info"><strong>Date:</strong> {{ r.dateReservation | date: 'dd/MM/yyyy' }}</p>
        <p class="modal-info"><strong>Atelier:</strong> {{ r.atelierNom }}</p>
        <p class="modal-info"><strong>Description:</strong> {{ r.atelierDescription }}</p>
        <p class="modal-info" *ngIf="r.coachNom"><strong>Coach:</strong> {{ r.coachNom }}</p>
        <p class="modal-info" *ngIf="r.coachSpecialite"><strong>Spécialité:</strong> {{ r.coachSpecialite }}</p>
      </div>
    </div>

    <div class="reservation-modal-footer">
      <button class="reservation-btn btn-primary confirm-btn" (click)="closeReservationConfirmation()">
        <i class="fas fa-check"></i>
        Fermer
      </button>
    </div>
  </div>
</div>


<app-footer></app-footer>
